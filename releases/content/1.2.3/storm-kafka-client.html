<h1 id="storm-apache-kafka-integration-using-the-kafka-client-jar">Storm Apache Kafka integration using the kafka-client jar</h1>
<p>This includes the new Apache Kafka consumer API.</p>

<h2 id="compatibility">Compatibility</h2>

<p>Apache Kafka versions 0.10.1.0 onwards. Please be aware that <a href="https://issues.apache.org/jira/browse/KAFKA-7044">KAFKA-7044</a> can cause crashes in the spout, so you should upgrade Kafka if you are using an affected version (1.1.0, 1.1.1 or 2.0.0).</p>

<h2 id="writing-to-kafka-as-part-of-your-topology">Writing to Kafka as part of your topology</h2>
<p>You can create an instance of org.apache.storm.kafka.bolt.KafkaBolt and attach it as a component to your topology or if you
are using trident you can use org.apache.storm.kafka.trident.TridentState, org.apache.storm.kafka.trident.TridentStateFactory and
org.apache.storm.kafka.trident.TridentKafkaUpdater.</p>

<p>You need to provide implementations for the following 2 interfaces</p>

<h3 id="tupletokafkamapper-and-tridenttupletokafkamapper">TupleToKafkaMapper and TridentTupleToKafkaMapper</h3>
<p>These interfaces have 2 methods defined:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">K</span> <span class="nf">getKeyFromTuple</span><span class="o">(</span><span class="nc">Tuple</span><span class="o">/</span><span class="nc">TridentTuple</span> <span class="n">tuple</span><span class="o">);</span>
<span class="no">V</span> <span class="nf">getMessageFromTuple</span><span class="o">(</span><span class="nc">Tuple</span><span class="o">/</span><span class="nc">TridentTuple</span> <span class="n">tuple</span><span class="o">);</span>
</code></pre></div></div>

<p>As the name suggests, these methods are called to map a tuple to a Kafka key and a Kafka message. If you just want one field
as key and one field as value, then you can use the provided FieldNameBasedTupleToKafkaMapper.java
implementation. In the KafkaBolt, the implementation always looks for a field with field name “key” and “message” if you
use the default constructor to construct FieldNameBasedTupleToKafkaMapper for backward compatibility
reasons. Alternatively you could also specify a different key and message field by using the non default constructor.
In the TridentKafkaState you must specify what is the field name for key and message as there is no default constructor.
These should be specified while constructing an instance of FieldNameBasedTupleToKafkaMapper.</p>

<h3 id="kafkatopicselector-and-trident-kafkatopicselector">KafkaTopicSelector and trident KafkaTopicSelector</h3>
<p>This interface has only one method</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">KafkaTopicSelector</span> <span class="o">{</span>
    <span class="nc">String</span> <span class="nf">getTopics</span><span class="o">(</span><span class="nc">Tuple</span><span class="o">/</span><span class="nc">TridentTuple</span> <span class="n">tuple</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The implementation of this interface should return the topic to which the tuple’s key/message mapping needs to be published
You can return a null and the message will be ignored. If you have one static topic name then you can use
DefaultTopicSelector.java and set the name of the topic in the constructor.
<code class="language-plaintext highlighter-rouge">FieldNameTopicSelector</code> and <code class="language-plaintext highlighter-rouge">FieldIndexTopicSelector</code> can be used to select the topic should to publish a tuple to.
A user just needs to specify the field name or field index for the topic name in the tuple itself.
When the topic is name not found , the <code class="language-plaintext highlighter-rouge">Field*TopicSelector</code> will write messages into default topic .
Please make sure the default topic has been created .</p>

<h3 id="specifying-kafka-producer-properties">Specifying Kafka producer properties</h3>
<p>You can provide all the producer properties in your Storm topology by calling <code class="language-plaintext highlighter-rouge">KafkaBolt.withProducerProperties()</code> and <code class="language-plaintext highlighter-rouge">TridentKafkaStateFactory.withProducerProperties()</code>. Please see  http://kafka.apache.org/documentation.html#newproducerconfigs
Section “Important configuration properties for the producer” for more details.
These are also defined in <code class="language-plaintext highlighter-rouge">org.apache.kafka.clients.producer.ProducerConfig</code></p>

<h3 id="using-wildcard-kafka-topic-match">Using wildcard kafka topic match</h3>
<p>You can do a wildcard topic match by adding the following config</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Config</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Config</span><span class="o">();</span>
<span class="n">config</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"kafka.topic.wildcard.match"</span><span class="o">,</span><span class="kc">true</span><span class="o">);</span>
</code></pre></div></div>

<p>After this you can specify a wildcard topic for matching e.g. clickstream.*.log.  This will match all streams matching clickstream.my.log, clickstream.cart.log etc</p>

<h3 id="putting-it-all-together">Putting it all together</h3>

<p>For the bolt :</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">TopologyBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyBuilder</span><span class="o">();</span>

<span class="nc">Fields</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Fields</span><span class="o">(</span><span class="s">"key"</span><span class="o">,</span> <span class="s">"message"</span><span class="o">);</span>
<span class="nc">FixedBatchSpout</span> <span class="n">spout</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FixedBatchSpout</span><span class="o">(</span><span class="n">fields</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"storm"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
            <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"trident"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
            <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"needs"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
            <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"javadoc"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">)</span>
<span class="o">);</span>
<span class="n">spout</span><span class="o">.</span><span class="na">setCycle</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
<span class="n">builder</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"spout"</span><span class="o">,</span> <span class="n">spout</span><span class="o">,</span> <span class="mi">5</span><span class="o">);</span>
<span class="c1">//set producer properties.</span>
<span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"bootstrap.servers"</span><span class="o">,</span> <span class="s">"localhost:9092"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"acks"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>

<span class="nc">KafkaBolt</span> <span class="n">bolt</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">KafkaBolt</span><span class="o">()</span>
        <span class="o">.</span><span class="na">withProducerProperties</span><span class="o">(</span><span class="n">props</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withTopicSelector</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultTopicSelector</span><span class="o">(</span><span class="s">"test"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withTupleToKafkaMapper</span><span class="o">(</span><span class="k">new</span> <span class="nc">FieldNameBasedTupleToKafkaMapper</span><span class="o">());</span>
<span class="n">builder</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"forwardToKafka"</span><span class="o">,</span> <span class="n">bolt</span><span class="o">,</span> <span class="mi">8</span><span class="o">).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"spout"</span><span class="o">);</span>

<span class="nc">Config</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Config</span><span class="o">();</span>

<span class="nc">StormSubmitter</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="s">"kafkaboltTest"</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">builder</span><span class="o">.</span><span class="na">createTopology</span><span class="o">());</span>
</code></pre></div></div>

<p>For Trident:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Fields</span> <span class="n">fields</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Fields</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span> <span class="s">"count"</span><span class="o">);</span>
<span class="nc">FixedBatchSpout</span> <span class="n">spout</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FixedBatchSpout</span><span class="o">(</span><span class="n">fields</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span>
        <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"storm"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
        <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"trident"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
        <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"needs"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">),</span>
        <span class="k">new</span> <span class="nf">Values</span><span class="o">(</span><span class="s">"javadoc"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">)</span>
<span class="o">);</span>
<span class="n">spout</span><span class="o">.</span><span class="na">setCycle</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>

<span class="nc">TridentTopology</span> <span class="n">topology</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TridentTopology</span><span class="o">();</span>
<span class="nc">Stream</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">topology</span><span class="o">.</span><span class="na">newStream</span><span class="o">(</span><span class="s">"spout1"</span><span class="o">,</span> <span class="n">spout</span><span class="o">);</span>

<span class="c1">//set producer properties.</span>
<span class="nc">Properties</span> <span class="n">props</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Properties</span><span class="o">();</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"bootstrap.servers"</span><span class="o">,</span> <span class="s">"localhost:9092"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"acks"</span><span class="o">,</span> <span class="s">"1"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"key.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>
<span class="n">props</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">"value.serializer"</span><span class="o">,</span> <span class="s">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="o">);</span>

<span class="nc">TridentKafkaStateFactory</span> <span class="n">stateFactory</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TridentKafkaStateFactory</span><span class="o">()</span>
        <span class="o">.</span><span class="na">withProducerProperties</span><span class="o">(</span><span class="n">props</span><span class="o">)</span>
        <span class="o">.</span><span class="na">withKafkaTopicSelector</span><span class="o">(</span><span class="k">new</span> <span class="nc">DefaultTopicSelector</span><span class="o">(</span><span class="s">"test"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">withTridentTupleToKafkaMapper</span><span class="o">(</span><span class="k">new</span> <span class="nc">FieldNameBasedTupleToKafkaMapper</span><span class="o">(</span><span class="s">"word"</span><span class="o">,</span> <span class="s">"count"</span><span class="o">));</span>
<span class="n">stream</span><span class="o">.</span><span class="na">partitionPersist</span><span class="o">(</span><span class="n">stateFactory</span><span class="o">,</span> <span class="n">fields</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TridentKafkaStateUpdater</span><span class="o">(),</span> <span class="k">new</span> <span class="nc">Fields</span><span class="o">());</span>

<span class="nc">Config</span> <span class="n">conf</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Config</span><span class="o">();</span>
<span class="nc">StormSubmitter</span><span class="o">.</span><span class="na">submitTopology</span><span class="o">(</span><span class="s">"kafkaTridentTest"</span><span class="o">,</span> <span class="n">conf</span><span class="o">,</span> <span class="n">topology</span><span class="o">.</span><span class="na">build</span><span class="o">());</span>
</code></pre></div></div>

<h2 id="reading-from-kafka-spouts">Reading From kafka (Spouts)</h2>

<h3 id="configuration">Configuration</h3>

<p>The spout implementations are configured by use of the <code class="language-plaintext highlighter-rouge">KafkaSpoutConfig</code> class.  This class uses a Builder pattern and can be started either by calling one of
the Builders constructors or by calling the static method builder in the KafkaSpoutConfig class.</p>

<p>The Constructor or static method to create the builder require a few key values (that can be changed later on) but are the minimum config needed to start
a spout.</p>

<p><code class="language-plaintext highlighter-rouge">bootstrapServers</code> is the same as the Kafka Consumer Property “bootstrap.servers”.
<code class="language-plaintext highlighter-rouge">topics</code> The topics the spout will consume can either be a <code class="language-plaintext highlighter-rouge">Collection</code> of specific topic names (1 or more) or a regular expression <code class="language-plaintext highlighter-rouge">Pattern</code>, which specifies
that any topics that match that regular expression will be consumed.</p>

<p>If you are using the Builder Constructors instead of one of the <code class="language-plaintext highlighter-rouge">builder</code> methods, you will also need to specify a key deserializer and a value deserializer.  This is to help guarantee type safety through the use
of Java generics.  The deserializers can be specified via the consumer properties set with <code class="language-plaintext highlighter-rouge">setProp</code>. See the KafkaConsumer configuration documentation for details.</p>

<p>There are a few key configs to pay attention to.</p>

<p><code class="language-plaintext highlighter-rouge">setFirstPollOffsetStrategy</code> allows you to set where to start consuming data from.  This is used both in case of failure recovery and starting the spout
for the first time. The allowed values are listed in the <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.FirstPollOffsetStrategy.html">FirstPollOffsetStrategy javadocs</a>.</p>

<p><code class="language-plaintext highlighter-rouge">setProcessingGuarantee</code> lets you configure what processing guarantees the spout will provide. This affects how soon consumed offsets can be committed, and the frequency of commits. See the <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.ProcessingGuarantee.html">ProcessingGuarantee javadoc</a> for details.</p>

<p><code class="language-plaintext highlighter-rouge">setRecordTranslator</code> allows you to modify how the spout converts a Kafka Consumer Record into a Tuple, and which stream that tuple will be published into.
By default the “topic”, “partition”, “offset”, “key”, and “value” will be emitted to the “default” stream.  If you want to output entries to different
streams based on the topic, storm provides <code class="language-plaintext highlighter-rouge">ByTopicRecordTranslator</code>.  See below for more examples on how to use these.</p>

<p><code class="language-plaintext highlighter-rouge">setProp</code> and <code class="language-plaintext highlighter-rouge">setProps</code> can be used to set KafkaConsumer properties. The list of these properties can be found in the KafkaConsumer configuration documentation on the <a href="http://kafka.apache.org/documentation.html#consumerconfigs">Kafka website</a>. Note that KafkaConsumer autocommit is unsupported. The KafkaSpoutConfig constructor will throw an exception if the “enable.auto.commit” property is set, and the consumer used by the spout will always have that property set to false. You can configure similar behavior to autocommit through the <code class="language-plaintext highlighter-rouge">setProcessingGuarantee</code> method on the KafkaSpoutConfig builder.</p>

<h3 id="usage-examples">Usage Examples</h3>

<p>The API is written with java 8 lambda expressions in mind.  It works with java7 and below though.</p>

<h4 id="create-a-simple-insecure-spout">Create a Simple Insecure Spout</h4>
<p>The following will consume all events published to “topic” and send them to MyBolt with the fields “topic”, “partition”, “offset”, “key”, “value”.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">final</span> <span class="nc">TopologyBuilder</span> <span class="n">tp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyBuilder</span><span class="o">();</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">KafkaSpout</span><span class="o">&lt;&gt;(</span><span class="nc">KafkaSpoutConfig</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">"127.0.0.1:"</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="s">"topic"</span><span class="o">).</span><span class="na">build</span><span class="o">()),</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"bolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">myBolt</span><span class="o">()).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div></div>

<h4 id="wildcard-topics">Wildcard Topics</h4>
<p>Wildcard topics will consume from all topics that exist in the specified brokers list and match the pattern.  So in the following example
“topic”, “topic_foo” and “topic_bar” will all match the pattern “topic.*”, but “not_my_topic” would not match.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kd">final</span> <span class="nc">TopologyBuilder</span> <span class="n">tp</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TopologyBuilder</span><span class="o">();</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setSpout</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">,</span> <span class="k">new</span> <span class="nc">KafkaSpout</span><span class="o">&lt;&gt;(</span><span class="nc">KafkaSpoutConfig</span><span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="s">"127.0.0.1:"</span> <span class="o">+</span> <span class="n">port</span><span class="o">,</span> <span class="nc">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"topic.*"</span><span class="o">)).</span><span class="na">build</span><span class="o">()),</span> <span class="mi">1</span><span class="o">);</span>
<span class="n">tp</span><span class="o">.</span><span class="na">setBolt</span><span class="o">(</span><span class="s">"bolt"</span><span class="o">,</span> <span class="k">new</span> <span class="n">myBolt</span><span class="o">()).</span><span class="na">shuffleGrouping</span><span class="o">(</span><span class="s">"kafka_spout"</span><span class="o">);</span>
<span class="o">...</span>
</code></pre></div></div>

<h4 id="multiple-streams">Multiple Streams</h4>

<p>This uses java 8 lambda expressions.</p>

<p>final TopologyBuilder tp = new TopologyBuilder();</p>

<p>//By default all topics not covered by another rule, but consumed by the spout will be emitted to “STREAM_1” as “topic”, “key”, and “value”
ByTopicRecordTranslator&lt;String, String&gt; byTopic = new ByTopicRecordTranslator&lt;&gt;(
    (r) -&gt; new Values(r.topic(), r.key(), r.value()),
    new Fields(“topic”, “key”, “value”), “STREAM_1”);
//For topic_2 all events will be emitted to “STREAM_2” as just “key” and “value”
byTopic.forTopic(“topic_2”, (r) -&gt; new Values(r.key(), r.value()), new Fields(“key”, “value”), “STREAM_2”);</p>

<p>tp.setSpout(“kafka_spout”, new KafkaSpout&lt;&gt;(KafkaSpoutConfig.builder(“127.0.0.1:” + port, “topic_1”, “topic_2”, “topic_3”).build()), 1);
tp.setBolt(“bolt”, new myBolt()).shuffleGrouping(“kafka_spout”, “STREAM_1”);
tp.setBolt(“another”, new myOtherBolt()).shuffleGrouping(“kafka_spout”, “STREAM_2”);
…</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
#### Trident

```java
final TridentTopology tridentTopology = new TridentTopology();
final Stream spoutStream = tridentTopology.newStream("kafkaSpout",
    new KafkaTridentSpoutOpaque&lt;&gt;(KafkaSpoutConfig.builder("127.0.0.1:" + port, Pattern.compile("topic.*")).build()))
      .parallelismHint(1)
...
</code></pre></div></div>

<p>Trident does not support multiple streams and will ignore any streams set for output.  If however the Fields are not identical for each
output topic it will throw an exception and not continue.</p>

<h3 id="custom-recordtranslators-advanced">Custom RecordTranslators (ADVANCED)</h3>

<p>In most cases the built in SimpleRecordTranslator and ByTopicRecordTranslator should cover your use case.  If you do run into a situation where you need a custom one
then this documentation will describe how to do this properly, and some of the less than obvious classes involved.</p>

<p>The point of <code class="language-plaintext highlighter-rouge">apply</code> is to take a ConsumerRecord and turn it into a <code class="language-plaintext highlighter-rouge">List&lt;Object&gt;</code> that can be emitted.  What is not obvious is how to tell the spout to emit it to a
specific stream.  To do this you will need to return an instance of <code class="language-plaintext highlighter-rouge">org.apache.storm.kafka.spout.KafkaTuple</code>.  This provides a method <code class="language-plaintext highlighter-rouge">routedTo</code> that will say which
specific stream the tuple should go to.</p>

<p>For Example:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="k">new</span> <span class="nc">KafkaTuple</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">).</span><span class="na">routedTo</span><span class="o">(</span><span class="s">"bar"</span><span class="o">);</span>
</code></pre></div></div>

<p>Will cause the tuple to be emitted on the “bar” stream.</p>

<p>Be careful when writing custom record translators because just like in a storm spout it needs to be self consistent.  The <code class="language-plaintext highlighter-rouge">streams</code> method should return
a full set of streams that this translator will ever try to emit on.  Additionally <code class="language-plaintext highlighter-rouge">getFieldsFor</code> should return a valid Fields object for each of those
streams.  If you are doing this for Trident a value must be in the List returned by <code class="language-plaintext highlighter-rouge">apply</code> for every field in the Fields object for that stream,
otherwise trident can throw exceptions.</p>

<h3 id="manual-partition-assigment-advanced">Manual Partition Assigment (ADVANCED)</h3>

<p>By default the KafkaSpout instances will be assigned partitions using a round robin strategy. If you need to customize partition assignment, you must implement the <code class="language-plaintext highlighter-rouge">ManualPartitioner</code> interface. The implementation can be passed to the <code class="language-plaintext highlighter-rouge">ManualPartitionSubscription</code> constructor, and the <code class="language-plaintext highlighter-rouge">Subscription</code> can then be set in the <code class="language-plaintext highlighter-rouge">KafkaSpoutConfig</code> via the <code class="language-plaintext highlighter-rouge">KafkaSpoutConfig.Builder</code> constructor. Please take care when supplying a custom implementation, since an incorrect <code class="language-plaintext highlighter-rouge">ManualPartitioner</code> implementation could leave some partitions unread, or concurrently read by multiple spout instances. See the <code class="language-plaintext highlighter-rouge">RoundRobinManualPartitioner</code> for an example of how to implement this functionality.</p>

<h2 id="use-the-maven-shade-plugin-to-build-the-uber-jar">Use the Maven Shade Plugin to Build the Uber Jar</h2>

<p>Add the following to <code class="language-plaintext highlighter-rouge">REPO_HOME/storm/external/storm-kafka-client/pom.xml</code></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;plugin&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>maven-shade-plugin<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>2.4.1<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;executions&gt;</span>
        <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;phase&gt;</span>package<span class="nt">&lt;/phase&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
                <span class="nt">&lt;goal&gt;</span>shade<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
                <span class="nt">&lt;transformers&gt;</span>
                    <span class="nt">&lt;transformer</span> <span class="na">implementation=</span><span class="s">"org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;mainClass&gt;</span>org.apache.storm.kafka.spout.test.KafkaSpoutTopologyMain<span class="nt">&lt;/mainClass&gt;</span>
                    <span class="nt">&lt;/transformer&gt;</span>
                <span class="nt">&lt;/transformers&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
        <span class="nt">&lt;/execution&gt;</span>
    <span class="nt">&lt;/executions&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</code></pre></div></div>

<p>create the uber jar by running the command:</p>

<p><code class="language-plaintext highlighter-rouge">mvn package -f REPO_HOME/storm/external/storm-kafka-client/pom.xml</code></p>

<p>This will create the uber jar file with the name and location matching the following pattern:</p>

<p><code class="language-plaintext highlighter-rouge">REPO_HOME/storm/external/storm-kafka-client/target/storm-kafka-client-1.0.x.jar</code></p>

<h3 id="run-storm-topology">Run Storm Topology</h3>

<p>Copy the file <code class="language-plaintext highlighter-rouge">REPO_HOME/storm/external/storm-kafka-client/target/storm-kafka-client-*.jar</code> to <code class="language-plaintext highlighter-rouge">STORM_HOME/extlib</code></p>

<p>Using the Kafka command line tools create three topics [test, test1, test2] and use the Kafka console producer to populate the topics with some data</p>

<p>Execute the command <code class="language-plaintext highlighter-rouge">STORM_HOME/bin/storm jar REPO_HOME/storm/external/storm/target/storm-kafka-client-*.jar org.apache.storm.kafka.spout.test.KafkaSpoutTopologyMain</code></p>

<p>With the debug level logs enabled it is possible to see the messages of each topic being redirected to the appropriate Bolt as defined 
by the streams defined and choice of shuffle grouping.</p>

<h2 id="using-storm-kafka-client-with-different-versions-of-kafka">Using storm-kafka-client with different versions of kafka</h2>

<p>Storm-kafka-client’s Kafka dependency is defined as <code class="language-plaintext highlighter-rouge">provided</code> scope in maven, meaning it will not be pulled in
as a transitive dependency. This allows you to use a version of Kafka dependency compatible with your kafka cluster.</p>

<p>When building a project with storm-kafka-client, you must explicitly add the Kafka clients dependency. For example, to
use Kafka-clients 0.10.0.0, you would use the following dependency in your <code class="language-plaintext highlighter-rouge">pom.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.kafka<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>kafka-clients<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>0.10.0.0<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></div>

<p>You can also override the kafka clients version while building from maven, with parameter <code class="language-plaintext highlighter-rouge">storm.kafka.client.version</code>
e.g. <code class="language-plaintext highlighter-rouge">mvn clean install -Dstorm.kafka.client.version=0.10.0.0</code></p>

<p>When selecting a kafka client version, you should ensure -</p>
<ol>
  <li>kafka api is compatible. storm-kafka-client module only supports <strong>0.10 or newer</strong> kafka client API. For older versions,
 you can use storm-kafka module (https://github.com/apache/storm/tree/master/external/storm-kafka).</li>
  <li>The kafka client selected by you should be wire compatible with the broker. e.g. 0.9.x client will not work with 
 0.8.x broker.</li>
</ol>

<h1 id="kafka-spout-performance-tuning">Kafka Spout Performance Tuning</h1>

<p>The Kafka spout provides two internal parameters to control its performance. The parameters can be set using the <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setOffsetCommitPeriodMs-long-">setOffsetCommitPeriodMs</a> and <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setMaxUncommittedOffsets-int-">setMaxUncommittedOffsets</a> methods.</p>

<ul>
  <li>“offset.commit.period.ms” controls how often the spout commits to Kafka</li>
  <li>“max.uncommitted.offsets” controls how many offsets can be pending commit before another poll can take place
<br /></li>
</ul>

<p>The [Kafka consumer config] (http://kafka.apache.org/documentation.html#consumerconfigs) parameters may also have an impact on the performance of the spout. The following Kafka parameters are likely the most influential in the spout performance:</p>

<ul>
  <li>“fetch.min.bytes”</li>
  <li>“fetch.max.wait.ms”</li>
  <li><a href="http://kafka.apache.org/090/javadoc/index.html?org/apache/kafka/clients/consumer/KafkaConsumer.html">Kafka Consumer</a> instance poll timeout, which is specified for each Kafka spout using the <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setPollTimeoutMs-long-">setPollTimeoutMs</a> method.
<br /></li>
</ul>

<p>Depending on the structure of your Kafka cluster, distribution of the data, and availability of data to poll, these parameters will have to be configured appropriately. Please refer to the Kafka documentation on Kafka parameter tuning.</p>

<h3 id="default-values">Default values</h3>

<p>Currently the Kafka spout has has the following default values, which have been shown to give good performance in the test environment as described in this [blog post] (https://hortonworks.com/blog/microbenchmarking-storm-1-0-performance/)</p>

<ul>
  <li>poll.timeout.ms = 200</li>
  <li>offset.commit.period.ms = 30000   (30s)</li>
  <li>max.uncommitted.offsets = 10000000
<br /></li>
</ul>

<h1 id="tuple-tracking">Tuple Tracking</h1>

<p>By default the spout only tracks emitted tuples when the processing guarantee is AT_LEAST_ONCE. It may be necessary to track
emitted tuples with other processing guarantees to benefit from Storm features such as showing complete latency in the UI,
or enabling backpressure with Config.TOPOLOGY_MAX_SPOUT_PENDING.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">KafkaSpoutConfig</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">&gt;</span> <span class="n">kafkaConf</span> <span class="o">=</span> <span class="nc">KafkaSpoutConfig</span>
  <span class="o">.</span><span class="na">builder</span><span class="o">(</span><span class="nc">String</span> <span class="n">bootstrapServers</span><span class="o">,</span> <span class="nc">String</span> <span class="o">...</span> <span class="n">topics</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setProcessingGuarantee</span><span class="o">(</span><span class="nc">ProcessingGuarantee</span><span class="o">.</span><span class="na">AT_MOST_ONCE</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setTupleTrackingEnforced</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</code></pre></div></div>

<p>Note: This setting has no effect with AT_LEAST_ONCE processing guarantee, where tuple tracking is required and therefore always enabled.</p>

<h1 id="mapping-from-storm-kafka-to-storm-kafka-client-spout-properties">Mapping from <code class="language-plaintext highlighter-rouge">storm-kafka</code> to <code class="language-plaintext highlighter-rouge">storm-kafka-client</code> spout properties</h1>

<p>This may not be an exhaustive list because the <code class="language-plaintext highlighter-rouge">storm-kafka</code> configs were taken from Storm 0.9.6
<a href="https://svn.apache.org/repos/asf/storm/site/releases/0.9.6/javadocs/storm/kafka/SpoutConfig.html">SpoutConfig</a> and
<a href="https://svn.apache.org/repos/asf/storm/site/releases/0.9.6/javadocs/storm/kafka/KafkaConfig.html">KafkaConfig</a>.
<code class="language-plaintext highlighter-rouge">storm-kafka-client</code> spout configurations were taken from Storm 1.0.6
<a href="https://storm.apache.org/releases/1.0.6/javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.html">KafkaSpoutConfig</a> 
and Kafka 0.10.1.0 <a href="https://kafka.apache.org/0101/javadoc/index.html?org/apache/kafka/clients/consumer/ConsumerConfig.html">ConsumerConfig</a>.</p>

<table>
  <thead>
    <tr>
      <th>SpoutConfig</th>
      <th>KafkaSpoutConfig/ConsumerConfig</th>
      <th>KafkaSpoutConfig Usage</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">startOffsetTime</code><br /><br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">EarliestTime</code><br /><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong><strong>__</strong> <br /> <strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">forceFromStart</code> <br /><br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">false</code> <br /><br /> <code class="language-plaintext highlighter-rouge">startOffsetTime</code> &amp; <code class="language-plaintext highlighter-rouge">forceFromStart</code> together determine the starting offset. <code class="language-plaintext highlighter-rouge">forceFromStart</code> determines whether the Zookeeper offset is ignored. <code class="language-plaintext highlighter-rouge">startOffsetTime</code> sets the timestamp that determines the beginning offset, in case there is no offset in Zookeeper, or the Zookeeper offset is ignored</td>
      <td><strong>Setting:</strong> <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.FirstPollOffsetStrategy.html"><code class="language-plaintext highlighter-rouge">FirstPollOffsetStrategy</code></a><br /><br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">UNCOMMITTED_EARLIEST</code> <br /><br /> <a href="#helper-table-for-setting-firstpolloffsetstrategy">Refer to the helper table</a> for picking <code class="language-plaintext highlighter-rouge">FirstPollOffsetStrategy</code> based on your <code class="language-plaintext highlighter-rouge">startOffsetTime</code> &amp; <code class="language-plaintext highlighter-rouge">forceFromStart</code> settings</td>
      <td><a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setFirstPollOffsetStrategy-org.apache.storm.kafka.spout.KafkaSpoutConfig.FirstPollOffsetStrategy-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setFirstPollOffsetStrategy(&lt;strategy-name&gt;)</code></a></td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">scheme</code><br /><br /> The interface that specifies how a <code class="language-plaintext highlighter-rouge">ByteBuffer</code> from a Kafka topic is transformed into Storm tuple <br /><strong>Default:</strong> <code class="language-plaintext highlighter-rouge">RawMultiScheme</code></td>
      <td><strong>Setting:</strong> <a href="https://kafka.apache.org/11/javadoc/org/apache/kafka/common/serialization/Deserializer.html"><code class="language-plaintext highlighter-rouge">Deserializers</code></a></td>
      <td><a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setProp-java.lang.String-java.lang.Object-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setProp(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, &lt;deserializer-class&gt;)</code></a><br /><br /> <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setProp-java.lang.String-java.lang.Object-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setProp(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, &lt;deserializer-class&gt;)</code></a></td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">fetchSizeBytes</code><br /><br /> Message fetch size – the number of bytes to attempt to fetch in one request to a Kafka server <br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">1MB</code></td>
      <td><strong>Setting:</strong> <a href="http://kafka.apache.org/10/documentation.html#newconsumerconfigs"><code class="language-plaintext highlighter-rouge">max.partition.fetch.bytes</code></a></td>
      <td><a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setProp-java.lang.String-java.lang.Object-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setProp(ConsumerConfig.MAX_PARTITION_FETCH_BYTES_CONFIG, &lt;int-value&gt;)</code></a></td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">bufferSizeBytes</code><br /><br /> Buffer size (in bytes) for network requests. The buffer size which consumer has for pulling data from producer <br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">1MB</code></td>
      <td><strong>Setting:</strong> <a href="http://kafka.apache.org/10/documentation.html#newconsumerconfigs"><code class="language-plaintext highlighter-rouge">receive.buffer.bytes</code></a></td>
      <td><a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setProp-java.lang.String-java.lang.Object-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setProp(ConsumerConfig.RECEIVE_BUFFER_CONFIG, &lt;int-value&gt;)</code></a></td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">socketTimeoutMs</code><br /><br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">10000</code></td>
      <td><strong>N/A</strong></td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">useStartOffsetTimeIfOffsetOutOfRange</code><br /><br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">true</code></td>
      <td><strong>Setting:</strong> <a href="http://kafka.apache.org/10/documentation.html#newconsumerconfigs"><code class="language-plaintext highlighter-rouge">auto.offset.reset</code></a> <br /><br /> <strong>Default:</strong> Note that the default value for <code class="language-plaintext highlighter-rouge">auto.offset.reset</code> is <code class="language-plaintext highlighter-rouge">earliest</code> if you have <a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.ProcessingGuarantee.html"><code class="language-plaintext highlighter-rouge">ProcessingGuarantee</code></a> set to <code class="language-plaintext highlighter-rouge">AT_LEAST_ONCE</code>, but the default value is <code class="language-plaintext highlighter-rouge">latest</code> otherwise.</td>
      <td><a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setProp-java.lang.String-java.lang.Object-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setProp(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &lt;String&gt;)</code></a></td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">fetchMaxWait</code><br /><br /> Maximum time in ms to wait for the response <br /> <strong>Default:</strong> <code class="language-plaintext highlighter-rouge">10000</code></td>
      <td><strong>Setting:</strong> <a href="http://kafka.apache.org/10/documentation.html#newconsumerconfigs"><code class="language-plaintext highlighter-rouge">fetch.max.wait.ms</code></a></td>
      <td><a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setProp-java.lang.String-java.lang.Object-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setProp(ConsumerConfig.FETCH_MAX_WAIT_MS_CONFIG, &lt;value&gt;)</code></a></td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">maxOffsetBehind</code><br /><br /> Specifies how long a spout attempts to retry the processing of a failed tuple. One of the scenarios is when a failing tuple’s offset is more than <code class="language-plaintext highlighter-rouge">maxOffsetBehind</code> behind the acked offset, the spout stops retrying the tuple.<br /><strong>Default:</strong> <code class="language-plaintext highlighter-rouge">LONG.MAX_VALUE</code></td>
      <td><strong>N/A</strong></td>
      <td> </td>
    </tr>
    <tr>
      <td><strong>Setting:</strong> <code class="language-plaintext highlighter-rouge">clientId</code></td>
      <td><strong>Setting:</strong> <a href="http://kafka.apache.org/10/documentation.html#newconsumerconfigs"><code class="language-plaintext highlighter-rouge">client.id</code></a></td>
      <td><a href="javadocs/org/apache/storm/kafka/spout/KafkaSpoutConfig.Builder.html#setProp-java.lang.String-java.lang.Object-"><code class="language-plaintext highlighter-rouge">&lt;KafkaSpoutConfig-Builder&gt;.setProp(ConsumerConfig.CLIENT_ID_CONFIG, &lt;String&gt;)</code></a></td>
    </tr>
  </tbody>
</table>

<p>If you are using this table to upgrade your topology to use <code class="language-plaintext highlighter-rouge">storm-kafka-client</code> instead of <code class="language-plaintext highlighter-rouge">storm-kafka</code>, then you will also need to migrate the consumer offsets from ZooKeeper to Kafka broker. Use <a href="https://github.com/apache/storm/tree/master/external/storm-kafka-migration"><code class="language-plaintext highlighter-rouge">storm-kafka-migration</code></a> tool to migrate the Kafka consumer offsets.</p>

<h4 id="helper-table-for-setting-firstpolloffsetstrategy">Helper table for setting <code class="language-plaintext highlighter-rouge">FirstPollOffsetStrategy</code></h4>

<p>Pick and set <code class="language-plaintext highlighter-rouge">FirstPollOffsetStrategy</code> based on <code class="language-plaintext highlighter-rouge">startOffsetTime</code> &amp; <code class="language-plaintext highlighter-rouge">forceFromStart</code> settings:</p>

<table>
  <thead>
    <tr>
      <th><code class="language-plaintext highlighter-rouge">startOffsetTime</code></th>
      <th><code class="language-plaintext highlighter-rouge">forceFromStart</code></th>
      <th><code class="language-plaintext highlighter-rouge">FirstPollOffsetStrategy</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EarliestTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td><code class="language-plaintext highlighter-rouge">EARLIEST</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EarliestTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td><code class="language-plaintext highlighter-rouge">UNCOMMITTED_EARLIEST</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">LatestTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">true</code></td>
      <td><code class="language-plaintext highlighter-rouge">LATEST</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">LatestTime</code></td>
      <td><code class="language-plaintext highlighter-rouge">false</code></td>
      <td><code class="language-plaintext highlighter-rouge">UNCOMMITTED_LATEST</code></td>
    </tr>
  </tbody>
</table>
